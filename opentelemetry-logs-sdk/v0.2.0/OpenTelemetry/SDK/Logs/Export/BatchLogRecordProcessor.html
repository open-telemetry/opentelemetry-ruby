<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor
  
    &mdash; OpenTelemetry
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor";
  relpath = '../../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../../_index.html">Index (B)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../SDK.html" title="OpenTelemetry::SDK (module)">SDK</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Logs.html" title="OpenTelemetry::SDK::Logs (module)">Logs</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Export.html" title="OpenTelemetry::SDK::Logs::Export (module)">Export</a></span></span>
     &raquo; 
    <span class="title">BatchLogRecordProcessor</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../LogRecordProcessor.html" title="OpenTelemetry::SDK::Logs::LogRecordProcessor (class)">LogRecordProcessor</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../LogRecordProcessor.html" title="OpenTelemetry::SDK::Logs::LogRecordProcessor (class)">LogRecordProcessor</a></span></li>
          
            <li class="next">OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/opentelemetry/sdk/logs/export/batch_log_record_processor.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>WARNING - The spec has some differences from the LogRecord version of this processor Implementation of the duck type LogRecordProcessor that batches log records exported by the SDK then pushes them to the exporter pipeline.</p>

<p>Typically, the BatchLogRecordProcessor will be more suitable for production environments than the SimpleLogRecordProcessor.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#force_flush-instance_method" title="#force_flush (instance method)">#<strong>force_flush</strong>(timeout: nil)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Export all emitted log records that have not yet been exported to the configured <code>Exporter</code>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(exporter, exporter_timeout: Float(ENV.fetch(&#39;OTEL_BLRP_EXPORT_TIMEOUT&#39;, 30_000)), schedule_delay: Float(ENV.fetch(&#39;OTEL_BLRP_SCHEDULE_DELAY&#39;, 1000)), max_queue_size: Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_QUEUE_SIZE&#39;, 2048)), max_export_batch_size: Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_EXPORT_BATCH_SIZE&#39;, 512)), start_thread_on_boot: String(ENV[&#39;OTEL_RUBY_BLRP_START_THREAD_ON_BOOT&#39;]) !~ /false/i)  &#x21d2; Object </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns a new instance of the <span class='object_link'><a href="" title="OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor (class)">BatchLogRecordProcessor</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#on_emit-instance_method" title="#on_emit (instance method)">#<strong>on_emit</strong>(log_record, _context)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a log record to the batch.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#shutdown-instance_method" title="#shutdown (instance method)">#<strong>shutdown</strong>(timeout: nil)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Shuts the consumer thread down and flushes the current accumulated buffer will block until the thread is finished.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(exporter, exporter_timeout: Float(ENV.fetch(&#39;OTEL_BLRP_EXPORT_TIMEOUT&#39;, 30_000)), schedule_delay: Float(ENV.fetch(&#39;OTEL_BLRP_SCHEDULE_DELAY&#39;, 1000)), max_queue_size: Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_QUEUE_SIZE&#39;, 2048)), max_export_batch_size: Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_EXPORT_BATCH_SIZE&#39;, 512)), start_thread_on_boot: String(ENV[&#39;OTEL_RUBY_BLRP_START_THREAD_ON_BOOT&#39;]) !~ /false/i)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of the <span class='object_link'><a href="" title="OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor (class)">OpenTelemetry::SDK::Logs::Export::BatchLogRecordProcessor</a></span>.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>exporter</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="LogRecordExporter.html" title="OpenTelemetry::SDK::Logs::Export::LogRecordExporter (class)">LogRecordExporter</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The (duck type) LogRecordExporter to where the recorded LogRecords are pushed after batching.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>exporter_timeout</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Float(ENV.fetch(&#39;OTEL_BLRP_EXPORT_TIMEOUT&#39;, 30_000))</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The maximum allowed time to export data. Defaults to the value of the OTEL_BLRP_EXPORT_TIMEOUT environment variable, if set, or 30,000 (30 seconds).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>schedule_delay</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Float(ENV.fetch(&#39;OTEL_BLRP_SCHEDULE_DELAY&#39;, 1000))</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>the delay interval between two consecutive exports. Defaults to the value of the OTEL_BLRP_SCHEDULE_DELAY environment variable, if set, or 1,000 (1 second).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>max_queue_size</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_QUEUE_SIZE&#39;, 2048))</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>the maximum queue size in log records. Defaults to the value of the OTEL_BLRP_MAX_QUEUE_SIZE environment variable, if set, or 2048.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>max_export_batch_size</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Integer(ENV.fetch(&#39;OTEL_BLRP_MAX_EXPORT_BATCH_SIZE&#39;, 512))</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>the maximum batch size in log records. Defaults to the value of the OTEL_BLRP_MAX_EXPORT_BATCH_SIZE environment variable, if set, or 512.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/logs/export/batch_log_record_processor.rb', line 37</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_exporter'>exporter</span><span class='comma'>,</span>
               <span class='label'>exporter_timeout:</span> <span class='const'>Float</span><span class='lparen'>(</span><span class='const'>ENV</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_BLRP_EXPORT_TIMEOUT</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>30_000</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='comma'>,</span>
               <span class='label'>schedule_delay:</span> <span class='const'>Float</span><span class='lparen'>(</span><span class='const'>ENV</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_BLRP_SCHEDULE_DELAY</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>1000</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='comma'>,</span>
               <span class='label'>max_queue_size:</span> <span class='const'>Integer</span><span class='lparen'>(</span><span class='const'>ENV</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_BLRP_MAX_QUEUE_SIZE</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2048</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='comma'>,</span>
               <span class='label'>max_export_batch_size:</span> <span class='const'>Integer</span><span class='lparen'>(</span><span class='const'>ENV</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_BLRP_MAX_EXPORT_BATCH_SIZE</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>512</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='comma'>,</span>
               <span class='label'>start_thread_on_boot:</span> <span class='const'>String</span><span class='lparen'>(</span><span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_RUBY_BLRP_START_THREAD_ON_BOOT</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>!~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>false</span><span class='regexp_end'>/i</span></span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_max_export_batch_size'>max_export_batch_size</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_max_queue_size'>max_queue_size</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>max_export_batch_size much be less than or equal to max_queue_size</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_valid_exporter?'>valid_exporter?</span><span class='lparen'>(</span><span class='id identifier rubyid_exporter'>exporter</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exporter </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exporter'>exporter</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> does not appear to be a valid exporter</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@exporter</span> <span class='op'>=</span> <span class='id identifier rubyid_exporter'>exporter</span>
  <span class='ivar'>@exporter_timeout_seconds</span> <span class='op'>=</span> <span class='id identifier rubyid_exporter_timeout'>exporter_timeout</span> <span class='op'>/</span> <span class='float'>1000.0</span>
  <span class='ivar'>@mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@export_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@condition</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@keep_running</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@stopped</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@delay_seconds</span> <span class='op'>=</span> <span class='id identifier rubyid_schedule_delay'>schedule_delay</span> <span class='op'>/</span> <span class='float'>1000.0</span>
  <span class='ivar'>@max_queue_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max_queue_size'>max_queue_size</span>
  <span class='ivar'>@batch_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max_export_batch_size'>max_export_batch_size</span>
  <span class='ivar'>@log_records</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@pid</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_reset_on_fork'>reset_on_fork</span><span class='lparen'>(</span><span class='label'>restart_thread:</span> <span class='id identifier rubyid_start_thread_on_boot'>start_thread_on_boot</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="force_flush-instance_method">
  
    #<strong>force_flush</strong>(timeout: nil)  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Export all emitted log records that have not yet been exported to the configured <code>Exporter</code>.</p>

<p>This method should only be called in cases where it is absolutely necessary, such as when using some FaaS providers that may suspend the process after an invocation, but before the <code>Processor</code> exports the completed log records.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>optional Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>An optional timeout in seconds.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>SUCCESS if no error occurred, FAILURE if a non-specific failure occurred, TIMEOUT if a timeout occurred.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/logs/export/batch_log_record_processor.rb', line 96</span>

<span class='kw'>def</span> <span class='id identifier rubyid_force_flush'>force_flush</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_start_time'>start_time</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_timeout_timestamp'>timeout_timestamp</span>

  <span class='id identifier rubyid_snapshot'>snapshot</span> <span class='op'>=</span> <span class='id identifier rubyid_lock'>lock</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_reset_on_fork'>reset_on_fork</span> <span class='kw'>if</span> <span class='ivar'>@keep_running</span>
    <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span><span class='lparen'>(</span><span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>until</span> <span class='id identifier rubyid_snapshot'>snapshot</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_remaining_timeout'>remaining_timeout</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_maybe_timeout'>maybe_timeout</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_start_time'>start_time</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='const'><span class='object_link'><a href="../Export.html#TIMEOUT-constant" title="OpenTelemetry::SDK::Logs::Export::TIMEOUT (constant)">TIMEOUT</a></span></span> <span class='kw'>if</span> <span class='id identifier rubyid_remaining_timeout'>remaining_timeout</span><span class='op'>&amp;.</span><span class='id identifier rubyid_zero?'>zero?</span>

    <span class='id identifier rubyid_batch'>batch</span> <span class='op'>=</span> <span class='id identifier rubyid_snapshot'>snapshot</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span><span class='lparen'>(</span><span class='id identifier rubyid_batch_size'>batch_size</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_log_record_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_result_code'>result_code</span> <span class='op'>=</span> <span class='id identifier rubyid_export_batch'>export_batch</span><span class='lparen'>(</span><span class='id identifier rubyid_batch'>batch</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='id identifier rubyid_remaining_timeout'>remaining_timeout</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_result_code'>result_code</span> <span class='kw'>unless</span> <span class='id identifier rubyid_result_code'>result_code</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="../Export.html#SUCCESS-constant" title="OpenTelemetry::SDK::Logs::Export::SUCCESS (constant)">SUCCESS</a></span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@exporter</span><span class='period'>.</span><span class='id identifier rubyid_force_flush'>force_flush</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_maybe_timeout'>maybe_timeout</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_start_time'>start_time</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>ensure</span>
  <span class='comment'># Unshift the remaining log records if we timed out. We drop excess
</span>  <span class='comment'># log records from the snapshot because they&#39;re older than any
</span>  <span class='comment'># records in the buffer.
</span>  <span class='id identifier rubyid_lock'>lock</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_n'>n</span> <span class='op'>=</span> <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>+</span> <span class='id identifier rubyid_snapshot'>snapshot</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>-</span> <span class='id identifier rubyid_max_queue_size'>max_queue_size</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_positive?'>positive?</span>
      <span class='id identifier rubyid_snapshot'>snapshot</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_report_dropped_log_records'>report_dropped_log_records</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='label'>reason:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>buffer-full</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_snapshot'>snapshot</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_snapshot'>snapshot</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='ivar'>@condition</span><span class='period'>.</span><span class='id identifier rubyid_signal'>signal</span> <span class='kw'>if</span> <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_queue_size'>max_queue_size</span> <span class='op'>/</span> <span class='int'>2</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="on_emit-instance_method">
  
    #<strong>on_emit</strong>(log_record, _context)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Adds a log record to the batch. Thread-safe; may block on lock.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/logs/export/batch_log_record_processor.rb', line 70</span>

<span class='kw'>def</span> <span class='id identifier rubyid_on_emit'>on_emit</span><span class='lparen'>(</span><span class='id identifier rubyid_log_record'>log_record</span><span class='comma'>,</span> <span class='id identifier rubyid__context'>_context</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@stopped</span>

  <span class='id identifier rubyid_lock'>lock</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_reset_on_fork'>reset_on_fork</span>
    <span class='id identifier rubyid_n'>n</span> <span class='op'>=</span> <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>+</span> <span class='int'>1</span> <span class='op'>-</span> <span class='id identifier rubyid_max_queue_size'>max_queue_size</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_positive?'>positive?</span>
      <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_report_dropped_log_records'>report_dropped_log_records</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='label'>reason:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>buffer-full</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_log_records'>log_records</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_log_record'>log_record</span>
    <span class='ivar'>@condition</span><span class='period'>.</span><span class='id identifier rubyid_signal'>signal</span> <span class='kw'>if</span> <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_batch_size'>batch_size</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="shutdown-instance_method">
  
    #<strong>shutdown</strong>(timeout: nil)  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Shuts the consumer thread down and flushes the current accumulated buffer will block until the thread is finished.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>optional Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>An optional timeout in seconds.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>SUCCESS if no error occurred, FAILURE if a non-specific failure occurred, TIMEOUT if a timeout occurred.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/logs/export/batch_log_record_processor.rb', line 137</span>

<span class='kw'>def</span> <span class='id identifier rubyid_shutdown'>shutdown</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@stopped</span>

  <span class='id identifier rubyid_start_time'>start_time</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_timeout_timestamp'>timeout_timestamp</span>
  <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='id identifier rubyid_lock'>lock</span> <span class='kw'>do</span>
    <span class='ivar'>@keep_running</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@stopped</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@condition</span><span class='period'>.</span><span class='id identifier rubyid_signal'>signal</span>
    <span class='ivar'>@thread</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_thread'>thread</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_force_flush'>force_flush</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_maybe_timeout'>maybe_timeout</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_start_time'>start_time</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_dropped_log_records'>dropped_log_records</span> <span class='op'>=</span> <span class='id identifier rubyid_lock'>lock</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_log_records'>log_records</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_report_dropped_log_records'>report_dropped_log_records</span><span class='lparen'>(</span><span class='id identifier rubyid_dropped_log_records'>dropped_log_records</span><span class='comma'>,</span> <span class='label'>reason:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>terminating</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_dropped_log_records'>dropped_log_records</span><span class='period'>.</span><span class='id identifier rubyid_positive?'>positive?</span>

  <span class='ivar'>@exporter</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Common</span><span class='op'>::</span><span class='const'>Utilities</span><span class='period'>.</span><span class='id identifier rubyid_maybe_timeout'>maybe_timeout</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_start_time'>start_time</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Feb 25 21:56:07 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.6).
</div>

    </div>
  </body>
</html>