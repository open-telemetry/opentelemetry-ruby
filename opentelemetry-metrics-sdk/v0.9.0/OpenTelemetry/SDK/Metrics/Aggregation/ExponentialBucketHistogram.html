<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram
  
    &mdash; OpenTelemetry
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram";
  relpath = '../../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../SDK.html" title="OpenTelemetry::SDK (module)">SDK</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Metrics.html" title="OpenTelemetry::SDK::Metrics (module)">Metrics</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Aggregation.html" title="OpenTelemetry::SDK::Metrics::Aggregation (module)">Aggregation</a></span></span>
     &raquo; 
    <span class="title">ExponentialBucketHistogram</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/opentelemetry/sdk/metrics/aggregation/exponential_bucket_histogram.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Contains the implementation of the <a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exponentialhistogram" target="_parent" title="ExponentialBucketHistogram">ExponentialBucketHistogram</a> aggregation</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="DEFAULT_SIZE-constant" class="">DEFAULT_SIZE =
          <div class="docstring">
  <div class="discussion">
    
<p>relate to min max scale: <a href="https://opentelemetry.io/docs/specs/otel/metrics/sdk/#support-a-minimum-and-maximum-scale">opentelemetry.io/docs/specs/otel/metrics/sdk/#support-a-minimum-and-maximum-scale</a></p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>160</span></pre></dd>
      
        <dt id="DEFAULT_SCALE-constant" class="">DEFAULT_SCALE =
          
        </dt>
        <dd><pre class="code"><span class='int'>20</span></pre></dd>
      
        <dt id="MAX_SCALE-constant" class="">MAX_SCALE =
          
        </dt>
        <dd><pre class="code"><span class='int'>20</span></pre></dd>
      
        <dt id="MIN_SCALE-constant" class="">MIN_SCALE =
          
        </dt>
        <dd><pre class="code"><span class='op'>-</span><span class='int'>10</span></pre></dd>
      
        <dt id="MIN_MAX_SIZE-constant" class="">MIN_MAX_SIZE =
          
        </dt>
        <dd><pre class="code"><span class='int'>2</span></pre></dd>
      
        <dt id="MAX_MAX_SIZE-constant" class="">MAX_MAX_SIZE =
          
        </dt>
        <dd><pre class="code"><span class='int'>16_384</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#aggregation_temporality-instance_method" title="#aggregation_temporality (instance method)">#<strong>aggregation_temporality</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>rubocop:enable Metrics/MethodLength.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#collect-instance_method" title="#collect (instance method)">#<strong>collect</strong>(start_time, end_time, data_points)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(aggregation_temporality: ENV.fetch(&#39;OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE&#39;, :delta), max_size: DEFAULT_SIZE, max_scale: DEFAULT_SCALE, record_min_max: true, zero_threshold: 0)  &#x21d2; ExponentialBucketHistogram </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The default boundaries are calculated based on default max_size and max_scale values.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update-instance_method" title="#update (instance method)">#<strong>update</strong>(amount, attributes, data_points)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>rubocop:disable Metrics/MethodLength.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(aggregation_temporality: ENV.fetch(&#39;OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE&#39;, :delta), max_size: DEFAULT_SIZE, max_scale: DEFAULT_SCALE, record_min_max: true, zero_threshold: 0)  &#x21d2; <tt><span class='object_link'><a href="" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram (class)">ExponentialBucketHistogram</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The default boundaries are calculated based on default max_size and max_scale values</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/metrics/aggregation/exponential_bucket_histogram.rb', line 28</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span>
  <span class='label'>aggregation_temporality:</span> <span class='const'>ENV</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:delta</span><span class='rparen'>)</span><span class='comma'>,</span>
  <span class='label'>max_size:</span> <span class='const'><span class='object_link'><a href="#DEFAULT_SIZE-constant" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram::DEFAULT_SIZE (constant)">DEFAULT_SIZE</a></span></span><span class='comma'>,</span>
  <span class='label'>max_scale:</span> <span class='const'><span class='object_link'><a href="#DEFAULT_SCALE-constant" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialBucketHistogram::DEFAULT_SCALE (constant)">DEFAULT_SCALE</a></span></span><span class='comma'>,</span>
  <span class='label'>record_min_max:</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='label'>zero_threshold:</span> <span class='int'>0</span>
<span class='rparen'>)</span>
  <span class='ivar'>@aggregation_temporality</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="AggregationTemporality.html" title="OpenTelemetry::SDK::Metrics::Aggregation::AggregationTemporality (class)">AggregationTemporality</a></span></span><span class='period'>.</span><span class='id identifier rubyid_determine_temporality'><span class='object_link'><a href="AggregationTemporality.html#determine_temporality-class_method" title="OpenTelemetry::SDK::Metrics::Aggregation::AggregationTemporality.determine_temporality (method)">determine_temporality</a></span></span><span class='lparen'>(</span><span class='label'>aggregation_temporality:</span> <span class='id identifier rubyid_aggregation_temporality'>aggregation_temporality</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='symbol'>:delta</span><span class='rparen'>)</span>
  <span class='ivar'>@record_min_max</span> <span class='op'>=</span> <span class='id identifier rubyid_record_min_max'>record_min_max</span>
  <span class='ivar'>@min</span>            <span class='op'>=</span> <span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span>
  <span class='ivar'>@max</span>            <span class='op'>=</span> <span class='op'>-</span><span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span>
  <span class='ivar'>@sum</span>            <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@count</span>          <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@zero_threshold</span> <span class='op'>=</span> <span class='id identifier rubyid_zero_threshold'>zero_threshold</span>
  <span class='ivar'>@zero_count</span>     <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@size</span>           <span class='op'>=</span> <span class='id identifier rubyid_validate_size'>validate_size</span><span class='lparen'>(</span><span class='id identifier rubyid_max_size'>max_size</span><span class='rparen'>)</span>
  <span class='ivar'>@scale</span>          <span class='op'>=</span> <span class='id identifier rubyid_validate_scale'>validate_scale</span><span class='lparen'>(</span><span class='id identifier rubyid_max_scale'>max_scale</span><span class='rparen'>)</span>

  <span class='ivar'>@mapping</span> <span class='op'>=</span> <span class='id identifier rubyid_new_mapping'>new_mapping</span><span class='lparen'>(</span><span class='ivar'>@scale</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="aggregation_temporality-instance_method">
  
    #<strong>aggregation_temporality</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>rubocop:enable Metrics/MethodLength</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


169
170
171</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/metrics/aggregation/exponential_bucket_histogram.rb', line 169</span>

<span class='kw'>def</span> <span class='id identifier rubyid_aggregation_temporality'>aggregation_temporality</span>
  <span class='ivar'>@aggregation_temporality</span><span class='period'>.</span><span class='id identifier rubyid_temporality'>temporality</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="collect-instance_method">
  
    #<strong>collect</strong>(start_time, end_time, data_points)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/metrics/aggregation/exponential_bucket_histogram.rb', line 49</span>

<span class='kw'>def</span> <span class='id identifier rubyid_collect'>collect</span><span class='lparen'>(</span><span class='id identifier rubyid_start_time'>start_time</span><span class='comma'>,</span> <span class='id identifier rubyid_end_time'>end_time</span><span class='comma'>,</span> <span class='id identifier rubyid_data_points'>data_points</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@aggregation_temporality</span><span class='period'>.</span><span class='id identifier rubyid_delta?'>delta?</span>
    <span class='comment'># Set timestamps and &#39;move&#39; data point values to result.
</span>    <span class='id identifier rubyid_hdps'>hdps</span> <span class='op'>=</span> <span class='id identifier rubyid_data_points'>data_points</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hdp'>hdp</span><span class='op'>|</span>
      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_start_time_unix_nano'>start_time_unix_nano</span> <span class='op'>=</span> <span class='id identifier rubyid_start_time'>start_time</span>
      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_time_unix_nano'>time_unix_nano</span> <span class='op'>=</span> <span class='id identifier rubyid_end_time'>end_time</span>
      <span class='id identifier rubyid_hdp'>hdp</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_data_points'>data_points</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='id identifier rubyid_hdps'>hdps</span>
  <span class='kw'>else</span>
    <span class='comment'># Update timestamps and take a snapshot.
</span>    <span class='id identifier rubyid_data_points'>data_points</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hdp'>hdp</span><span class='op'>|</span>
      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_start_time_unix_nano'>start_time_unix_nano</span> <span class='op'>||=</span> <span class='id identifier rubyid_start_time'>start_time</span> <span class='comment'># Start time of a data point is from the first observation.
</span>      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_time_unix_nano'>time_unix_nano</span> <span class='op'>=</span> <span class='id identifier rubyid_end_time'>end_time</span>
      <span class='id identifier rubyid_hdp'>hdp</span> <span class='op'>=</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_positive'>positive</span> <span class='op'>=</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_positive'>positive</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
      <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_negative'>negative</span> <span class='op'>=</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_negative'>negative</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
      <span class='id identifier rubyid_hdp'>hdp</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update-instance_method">
  
    #<strong>update</strong>(amount, attributes, data_points)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>rubocop:disable Metrics/MethodLength</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/opentelemetry/sdk/metrics/aggregation/exponential_bucket_histogram.rb', line 73</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span> <span class='id identifier rubyid_data_points'>data_points</span><span class='rparen'>)</span>
  <span class='comment'># fetch or initialize the ExponentialHistogramDataPoint
</span>  <span class='id identifier rubyid_hdp'>hdp</span> <span class='op'>=</span> <span class='id identifier rubyid_data_points'>data_points</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='id identifier rubyid_attributes'>attributes</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@record_min_max</span>
      <span class='id identifier rubyid_min'>min</span> <span class='op'>=</span> <span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span>
      <span class='id identifier rubyid_max'>max</span> <span class='op'>=</span> <span class='op'>-</span><span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_data_points'>data_points</span><span class='lbracket'>[</span><span class='id identifier rubyid_attributes'>attributes</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="ExponentialHistogramDataPoint.html" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogramDataPoint (class)">ExponentialHistogramDataPoint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
      <span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span>
      <span class='kw'>nil</span><span class='comma'>,</span>                                                               <span class='comment'># :start_time_unix_nano
</span>      <span class='int'>0</span><span class='comma'>,</span>                                                                 <span class='comment'># :time_unix_nano
</span>      <span class='int'>0</span><span class='comma'>,</span>                                                                 <span class='comment'># :count
</span>      <span class='int'>0</span><span class='comma'>,</span>                                                                 <span class='comment'># :sum
</span>      <span class='ivar'>@scale</span><span class='comma'>,</span>                                                            <span class='comment'># :scale
</span>      <span class='ivar'>@zero_count</span><span class='comma'>,</span>                                                       <span class='comment'># :zero_count
</span>      <span class='const'><span class='object_link'><a href="ExponentialHistogram.html" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram (module)">ExponentialHistogram</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="ExponentialHistogram/Buckets.html" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram::Buckets (class)">Buckets</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="ExponentialHistogram/Buckets.html#initialize-instance_method" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram::Buckets#initialize (method)">new</a></span></span><span class='comma'>,</span>  <span class='comment'># :positive
</span>      <span class='const'><span class='object_link'><a href="ExponentialHistogram.html" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram (module)">ExponentialHistogram</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="ExponentialHistogram/Buckets.html" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram::Buckets (class)">Buckets</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="ExponentialHistogram/Buckets.html#initialize-instance_method" title="OpenTelemetry::SDK::Metrics::Aggregation::ExponentialHistogram::Buckets#initialize (method)">new</a></span></span><span class='comma'>,</span>  <span class='comment'># :negative
</span>      <span class='int'>0</span><span class='comma'>,</span>                                                                 <span class='comment'># :flags
</span>      <span class='kw'>nil</span><span class='comma'>,</span>                                                               <span class='comment'># :exemplars
</span>      <span class='id identifier rubyid_min'>min</span><span class='comma'>,</span>                                                               <span class='comment'># :min
</span>      <span class='id identifier rubyid_max'>max</span><span class='comma'>,</span>                                                               <span class='comment'># :max
</span>      <span class='ivar'>@zero_threshold</span> <span class='comment'># :zero_threshold)
</span>    <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Start to populate the data point (esp. the buckets)
</span>  <span class='kw'>if</span> <span class='ivar'>@record_min_max</span>
    <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span> <span class='op'>=</span> <span class='id identifier rubyid_amount'>amount</span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
    <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span> <span class='op'>=</span> <span class='id identifier rubyid_amount'>amount</span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_sum'>sum</span> <span class='op'>+=</span> <span class='id identifier rubyid_amount'>amount</span>
  <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_abs'>abs</span> <span class='op'>&lt;=</span> <span class='ivar'>@zero_threshold</span>
    <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_zero_count'>zero_count</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_scale'>scale</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_zero_count'>zero_count</span> <span class='comment'># if always getting zero, then there is no point to keep doing the update
</span>    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># rescale, map to index, update the buckets here
</span>  <span class='id identifier rubyid_buckets'>buckets</span> <span class='op'>=</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_positive?'>positive?</span> <span class='op'>?</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_positive'>positive</span> <span class='op'>:</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_negative'>negative</span>
  <span class='id identifier rubyid_amount'>amount</span> <span class='op'>=</span> <span class='op'>-</span><span class='id identifier rubyid_amount'>amount</span> <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_negative?'>negative?</span>

  <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>=</span> <span class='ivar'>@mapping</span><span class='period'>.</span><span class='id identifier rubyid_map_to_index'>map_to_index</span><span class='lparen'>(</span><span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_rescaling_needed'>rescaling_needed</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_low'>low</span> <span class='op'>=</span> <span class='id identifier rubyid_high'>high</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_counts'>counts</span> <span class='op'>==</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='comment'># special case of empty
</span>    <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
    <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span>   <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
    <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_base'>index_base</span>  <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>

  <span class='kw'>elsif</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span> <span class='op'>-</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span><span class='rparen'>)</span> <span class='op'>&gt;=</span> <span class='ivar'>@size</span>
    <span class='id identifier rubyid_rescaling_needed'>rescaling_needed</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_low'>low</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
    <span class='id identifier rubyid_high'>high</span> <span class='op'>=</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span>

  <span class='kw'>elsif</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>-</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span><span class='rparen'>)</span> <span class='op'>&gt;=</span> <span class='ivar'>@size</span>
    <span class='id identifier rubyid_rescaling_needed'>rescaling_needed</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_low'>low</span> <span class='op'>=</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span>
    <span class='id identifier rubyid_high'>high</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_rescaling_needed'>rescaling_needed</span>
    <span class='id identifier rubyid_scale_change'>scale_change</span> <span class='op'>=</span> <span class='id identifier rubyid_get_scale_change'>get_scale_change</span><span class='lparen'>(</span><span class='id identifier rubyid_low'>low</span><span class='comma'>,</span> <span class='id identifier rubyid_high'>high</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_downscale'>downscale</span><span class='lparen'>(</span><span class='id identifier rubyid_scale_change'>scale_change</span><span class='comma'>,</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_positive'>positive</span><span class='comma'>,</span> <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_negative'>negative</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_new_scale'>new_scale</span> <span class='op'>=</span> <span class='ivar'>@mapping</span><span class='period'>.</span><span class='id identifier rubyid_scale'>scale</span> <span class='op'>-</span> <span class='id identifier rubyid_scale_change'>scale_change</span>
    <span class='id identifier rubyid_hdp'>hdp</span><span class='period'>.</span><span class='id identifier rubyid_scale'>scale</span> <span class='op'>=</span> <span class='id identifier rubyid_new_scale'>new_scale</span>
    <span class='ivar'>@mapping</span> <span class='op'>=</span> <span class='id identifier rubyid_new_mapping'>new_mapping</span><span class='lparen'>(</span><span class='id identifier rubyid_new_scale'>new_scale</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>=</span> <span class='ivar'>@mapping</span><span class='period'>.</span><span class='id identifier rubyid_map_to_index'>map_to_index</span><span class='lparen'>(</span><span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>

    <span class='const'><span class='object_link'><a href="../../../../OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Rescaled with new scale </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_new_scale'>new_scale</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_low'>low</span><span class='embexpr_end'>}</span><span class='tstring_content'> and </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_high'>high</span><span class='embexpr_end'>}</span><span class='tstring_content'>; bucket_index is updated to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket_index'>bucket_index</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># adjust buckets based on the bucket_index
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span>
    <span class='id identifier rubyid_span'>span</span> <span class='op'>=</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span> <span class='op'>-</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
    <span class='id identifier rubyid_grow_buckets'>grow_buckets</span><span class='lparen'>(</span><span class='id identifier rubyid_span'>span</span><span class='comma'>,</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span>
    <span class='id identifier rubyid_span'>span</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>-</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_start'>index_start</span>
    <span class='id identifier rubyid_grow_buckets'>grow_buckets</span><span class='lparen'>(</span><span class='id identifier rubyid_span'>span</span><span class='comma'>,</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_end'>index_end</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>-=</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_index_base'>index_base</span>
  <span class='id identifier rubyid_bucket_index'>bucket_index</span> <span class='op'>+=</span> <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_counts'>counts</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='kw'>if</span> <span class='id identifier rubyid_bucket_index'>bucket_index</span><span class='period'>.</span><span class='id identifier rubyid_negative?'>negative?</span>

  <span class='id identifier rubyid_buckets'>buckets</span><span class='period'>.</span><span class='id identifier rubyid_increment_bucket'>increment_bucket</span><span class='lparen'>(</span><span class='id identifier rubyid_bucket_index'>bucket_index</span><span class='rparen'>)</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed Aug 20 16:57:52 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.6).
</div>

    </div>
  </body>
</html>